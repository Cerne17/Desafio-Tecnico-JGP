services:
  # Serviço 1: ETL (Python)
  # Roda uma vez, cria o banco e desliga (exit 0)
  etl:
    build: ./etl
    volumes:
      - ./data:/app/data
      - ./backend/database:/app/schema
      - ./etl/input:/app/input
      - ./etl/scripts:/app/scripts
    command: sh scripts/run_pipeline.sh
    environment:
      - DB_PATH=/app/data/database.sqlite
      - EXCEL_FILE=/app/input/base_2025.xlsx
      - REPORT_FILE=/app/discrepancy_report.csv

  # Serviço 2: API (Node.js)
  # Fica rodando continuamente na porta 3000
  backend:
    build: ./backend
    ports:
      - "3000:3000"
    volumes:
      - ./data:/app/data
    depends_on:
      etl:
        condition: service_completed_successfully # Só inicia se o ETL rodar com sucesso
    environment:
      - DB_PATH=/app/data/database.sqlite
      - PORT=3000

  # Serviço 3: Frontend
  frontend:
    build: ./frontend
    ports:
      - "80:80" # Acessível em localhost
    depends_on:
      - backend
